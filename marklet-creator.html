<!-- Copyright (c) 2014 Jonathan Herman - MIT License (http://opensource.org/licenses/MIT) -->
<!--
hosted version:
	http://jdh11235.github.io/JSplaygrounds/marklet-creator.html
more info:
	http://github.com/jdh11235/JSplaygrounds
-->

<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<title>marklet-creator</title>

	<style>
		textarea {
			min-height: 4em;
		}

		.marklet {
			background-color: black;
			color: lime;
			padding: 0.5em;
			font-family: sans-serif;
		}

		#editorStatus {
			color: lime;
			display: inline-block;
			margin: 0 1em;
		}

		div {
			display: inline-block;
		}

		.info {
			color: brown;
		}
	</style>
</head>
<body>
	<i>JavaScript =&gt;</i>
	<textarea id="inputBox" oninput="undoStatus(); saveInputBox()" placeholder="type code, paste code, or drag-and-drop a file"></textarea>

	<button onclick="processScript()">Process</button>
	<button onclick="clearScript()">Clear</button>
	<p id="editorStatus"></p>

	<p class="info">(file drag-and-drop is not yet implemented)</p>

	<hr>

	<i>bookmarklet (drag to your Bookmarks Bar) =&gt;</i>
	<div>
		<input type="text" id="markletName" oninput="processName()" placeholder="rename bookmarklet">
		<br><br>
		<a href="javascript:(function(){})()" id="markletButton" class="marklet"></a>
	</div>

	<br><br>

	<i>processed bookmarklet source =&gt;</i>
	<textarea id="outputBox" placeholder="processed marklet source output"></textarea>

	<hr>

	<center>
		<a  class="info" href="http://github.com/jdh11235/JSplaygrounds">More Info...</a>
	</center>


	<script>
		var inputBox = document.getElementById('inputBox'),
			outputBox = document.getElementById('outputBox'),
			markletName = document.getElementById('markletName'),
			markletButton = document.getElementById('markletButton'),
			editorStatus = document.getElementById('editorStatus');
		loadBoxes();
		displayStatus();
		consoleMessages();

		function loadBoxes() {
			if (!localStorage.inputBox) localStorage.inputBox = '';
			if (localStorage.markletName) markletName.value = localStorage.markletName;
			if (!localStorage.markletScript) localStorage.markletScript = 'javascript:(function(){})()';

			processName();
			inputBox.value = localStorage.inputBox;
			displayMarklet(localStorage.markletScript);
		}

		function consoleMessages() {
			var message = ['currently wrapping marklet with:\n    ', '\nto change, use:\n    toggle: alternateWrapper(), default: alternateWrapper(false), non-encapsulating: alternateWrapper(true)\nand click Process or Clear'];
			if (localStorage.alternateWrapper) {
				console.log(message[0] + 'javascript:{ script };void(0)' + message[1]);
			} else {
				console.log(message[0] + 'javascript:(function(){ script })()' + message[1]);
			}
		}

		function alternateWrapper(state) {
			if (state === undefined) {
				if (localStorage.alternateWrapper) {
					localStorage.alternateWrapper = '';
					return false;
				} else {
					localStorage.alternateWrapper = true;
					return true;
				}
			}
			if (state === true) {
				localStorage.alternateWrapper = true;
				return true;
			}
			if (state === false) {
				localStorage.alternateWrapper = '';
				return false;
			}
		}

		function saveInputBox() {
			localStorage.inputBox = inputBox.value;
		}

		function displayName(name) {
			markletButton.innerHTML = name;
		}

		function displayStatus() {
			if (!localStorage.editorStatus) localStorage.editorStatus = '';
			editorStatus.innerHTML = localStorage.editorStatus;
		}

		function doStatus() {
			localStorage.editorStatus = 'done!';
			displayStatus();
		}

		function undoStatus() {
			localStorage.editorStatus = '';
			displayStatus();
		}

		function processName() {
			var name = markletName.value;
			localStorage.markletName = name;
			if (!name) name = 'Bookmarklet';
			displayName(name);
		}

		function displayMarklet(text) {
			outputBox.value = text;
			markletButton.href = text;
		}

		function markletify(text) {

			//remove single-line comments
			text = text.replace(/\/\/.*[\n\r]*/g, '');

			//encode special characters
			text = encodeURIComponent(text);

			//wrap into JavaScript URL
			if (localStorage.alternateWrapper) {
				text = 'javascript:{' + text + '};void(0)';
			} else {
				text = 'javascript:(function(){' + text + '})()';
			}

			return text;
		}

		function processScript() {
			var text = markletify(inputBox.value);
			displayMarklet(text);
			localStorage.markletScript = text;
			doStatus();
		}

		function clearScript() {
			inputBox.value = '';
			saveInputBox();
			processScript();
			undoStatus();
		}
	</script>
</body>
</html>
